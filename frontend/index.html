<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Curriculum Tutor</title>
    <!-- Cytoscape & CoSE-Bilkent for Compound Layout -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-cose-bilkent@4.1.0/cytoscape-cose-bilkent.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, auto;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Left: Chat Pane (35%) */
        #chat-pane {
            width: 35%;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            z-index: 2;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        }

        #chat-header {
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid #eee;
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            /* Flex alignment */
            align-items: center;
            /* Center Vertically */
            gap: 10px;
        }

        #chat-history {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .msg {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
            font-size: 0.95em;
            word-wrap: break-word;
        }

        .bot {
            background: white;
            border: 1px solid #eee;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .user {
            background: #007bff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        #chat-input-area {
            padding: 20px;
            background: #fff;
            border-top: 1px solid #eee;
        }

        #input-box {
            display: flex;
            gap: 10px;
        }

        input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            outline: none;
            font-size: 1em;
        }

        input:focus {
            border-color: #007bff;
        }

        button {
            padding: 0 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Right: Graph Pane (65%) */
        #graph-pane {
            width: 65%;
            position: relative;
            background: #fff;
        }

        #cy {
            width: 100%;
            height: 100%;
        }

        /* Overlays on Graph */
        #graph-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .graph-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        #legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            font-size: 0.85em;
        }

        /* Loading Overlay */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            color: #555;
            display: none;
        }
    </style>
</head>

<body>

    <div id="loading">Data Loading...</div>

    <!-- Left Chat -->
    <div id="chat-pane">
        <div id="chat-header">
            <span>ğŸ¤– AI Curriculum Tutor</span>
        </div>
        <div id="chat-history">
            <div class="msg bot">
                ì•ˆë…•í•˜ì„¸ìš”! ğŸ“<br>
                <strong>AI/ë°ì´í„° ì»¤ë¦¬í˜ëŸ¼ íŠœí„°</strong>ì…ë‹ˆë‹¤.<br><br>
                ì›í•˜ì‹œëŠ” ì§„ë¡œ(AI, ë°±ì—”ë“œ ë“±)ë¥¼ ë§ì”€í•´ ì£¼ì‹œë©´<br>
                ì˜¤ë¥¸ìª½ ê·¸ë˜í”„ì—ì„œ ë¡œë“œë§µì„ ë³´ì—¬ë“œë¦¬ê³  ì„¤ëª…í•´ ë“œë¦´ê²Œìš”.<br><br>
                <em>ì˜ˆ: "AI ëª¨ë¸ëŸ¬ ë˜ê³  ì‹¶ì–´", "ì„ í˜•ëŒ€ìˆ˜í•™ ë‹¤ìŒì—” ë­ ë“¤ì–´?"</em>
            </div>
        </div>
        <div id="chat-input-area">
            <div id="input-box">
                <input type="text" id="chat-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleEnter(event)">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Right Graph -->
    <div id="graph-pane">
        <div id="graph-controls">
            <button class="graph-btn" onclick="cy.fit()">Fit View</button>
            <button class="graph-btn" onclick="resetGraph()">Reset</button>
        </div>
        <div id="cy"></div>
        <div id="legend">
            ğŸ”µ JBNU | ğŸŸ  COSS | ğŸ“¦ Grouped by Domain
        </div>
    </div>

    <script>
        let cy;
        const colorMap = {
            'JBNU': '#007bff',
            'COSS': '#fd7e14'
        };

        // --- Init ---
        async function init() {
            document.getElementById('loading').style.display = 'flex';
            try {
                const response = await fetch('http://localhost:8000/graph');
                const data = await response.json();
                renderGraph(data);
                document.getElementById('loading').style.display = 'none';
            } catch (err) {
                console.error(err);
                alert("Backend Connection Failed. Ensure server is running on port 8000.");
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderGraph(data) {
            // Processing for Compound Nodes
            // 1. Identify Domains
            const domains = new Set();
            data.nodes.forEach(n => {
                if (n.domain && n.domain !== "Unknown") domains.add(n.domain);
            });

            // 2. Create Elements (Nodes + Compound Parents)
            const elements = [];

            // Add Parent Nodes (Groups)
            domains.forEach(d => {
                elements.push({
                    data: { id: `group_${d}`, label: d, type: 'group' },
                    classes: 'group-node'
                });
            });

            // Add Child Nodes
            data.nodes.forEach(n => {
                const parent = (n.domain && n.domain !== "Unknown") ? `group_${n.domain}` : null;
                // Add Source Prefix to Label for clarity
                const prefix = (n.type === 'JBNU') ? '[JBNU]' : '[COSS]';
                const label = `${prefix}\n${n.label}`;

                elements.push({
                    data: {
                        id: n.id,
                        label: label,
                        type: n.type,
                        semester: n.semester,
                        parent: parent
                    }
                });
            });

            // Add Edges
            data.edges.forEach((e, i) => {
                elements.push({
                    data: { id: `e${i}`, source: e.source, target: e.target }
                });
            });

            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node[type!="group"]',
                        style: {
                            'label': 'data(label)',
                            'text-wrap': 'wrap',
                            'text-valign': 'center', 'text-halign': 'center',
                            'color': '#fff',
                            'text-outline-width': 2, 'text-outline-color': '#333',
                            'background-color': ele => colorMap[ele.data('type')] || '#666',
                            'width': 'label', 'height': 'label',
                            'padding': '12px',
                            'shape': 'round-rectangle',
                            'font-size': '18px', /* Larger */
                            'font-weight': 'bold',
                            'min-zoomed-font-size': 8 /* Show text even when zoomed out */
                        }
                    },
                    {
                        selector: '.group-node', // Parent box
                        style: {
                            'label': 'data(label)',
                            'text-valign': 'top', 'text-halign': 'center',
                            'background-color': '#f8f9fa',
                            'border-width': 2, 'border-color': '#c3e6cb',
                            'shape': 'round-rectangle',
                            'color': '#28a745', 'font-weight': 'bold', 'font-size': '24px',
                            'padding': '15px'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#ced4da',
                            'target-arrow-color': '#ced4da',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'opacity': 0.8,
                            'arrow-scale': 1.2
                        }
                    },
                    {
                        selector: '.highlighted',
                        style: {
                            'background-color': '#ffc107', /* Yellow for highlight */
                            'line-color': '#ffc107',
                            'target-arrow-color': '#ffc107',
                            'border-color': '#fff',
                            'border-width': 4,
                            'color': '#000',
                            'text-outline-color': '#fff',
                            'z-index': 9999
                        }
                    },
                    {
                        selector: '.faded',
                        style: {
                            'opacity': 0.15
                        }
                    }
                ],
                layout: {
                    name: 'cose',
                    animate: true,
                    animationDuration: 800,
                    // Balanced again - previous was too tight
                    nodeRepulsion: 10000,
                    idealEdgeLength: 150,
                    componentSpacing: 100,
                    padding: 50,
                    randomize: true, /* Randomize initial positions to help untangle */
                    gravity: 0.1
                }
            });

            // Interaction: Tap on node types in Chat?
            cy.on('tap', 'node', evt => {
                const node = evt.target;
                if (node.isParent()) return; // Ignore tapping on group box
                sendSystemMessage(`ğŸ‘† **${node.data('label')}** ê³¼ëª©ì„ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ê´€ë ¨ ì •ë³´ë¥¼ ë³´ì—¬ë“œë¦´ê¹Œìš”?`);
            });
        }

        // --- Chat Logic ---
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            addMsg(msg, 'user');
            input.value = '';

            try {
                // Call Chat API
                const response = await fetch(`http://localhost:8000/chat?query=${encodeURIComponent(msg)}`);
                const data = await response.json();

                addMsg(data.answer, 'bot');

                // Logic to Update Graph
                if (data.roadmap && data.roadmap.length > 0) {
                    highlightGraph(data.roadmap);
                } else {
                    // If simple conversation, maybe reset graph?
                    // resetGraph();
                }

            } catch (err) {
                console.error(err);
                addMsg("Error connecting to server.", 'bot');
            }
        }

        function addMsg(html, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = html;
            const hist = document.getElementById('chat-history');
            hist.appendChild(div);
            hist.scrollTop = hist.scrollHeight;
        }

        function sendSystemMessage(text) {
            addMsg(text, 'bot');
        }

        function highlightGraph(subjects) {
            cy.elements().removeClass('highlighted faded');

            // Fade all first
            cy.elements().addClass('faded');

            const ids = new Set(subjects.map(s => s.ID));

            cy.batch(() => {
                // Highlight Nodes
                subjects.forEach(s => {
                    const el = cy.$id(s.ID);
                    el.removeClass('faded').addClass('highlighted');
                    // Also un-fade parent
                    if (el.parent().length > 0) el.parent().removeClass('faded');
                });

                // Highlight Edges
                cy.edges().forEach(e => {
                    if (ids.has(e.source().id()) && ids.has(e.target().id())) {
                        e.removeClass('faded').addClass('highlighted');
                    }
                });

                // Unfade Parents of highlighted nodes
                cy.nodes('.highlighted').parent().removeClass('faded');
            });

            // Zoom to fit highlighted
            cy.fit(cy.elements('.highlighted'), 50);
        }

        function resetGraph() {
            cy.elements().removeClass('highlighted faded');
            cy.fit();
        }

        init();
    </script>
</body>

</html>